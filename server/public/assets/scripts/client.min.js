/*! veggiekart 2016-03-11 */
var app=angular.module("veggieKart",["ngRoute"]);app.config(["$routeProvider","$locationProvider",function(a,b){a.when("/",{templateUrl:"views/login.html",controller:"loginController",controllerAs:"login"}).when("/admin/dashboard",{templateUrl:"views/dashboard.html",controller:"dashboardController",controllerAs:"dash"}).when("/farm/response",{templateUrl:"views/farmResponse.html",controller:"responseController",controllerAs:"farm"}).when("/admin/salad",{templateUrl:"views/salad.html",controller:"saladController",controllerAs:"salad"}).when("/admin/reports",{templateUrl:"views/reports.html",controller:"reportsController",controllerAs:"reports"}).when("/admin/confirm",{templateUrl:"views/requestConfirmation.html",controller:"confirmationController",controllerAs:"confirm"}).when("/admin/request",{templateUrl:"views/request.html",controller:"newRequestController",controllerAs:"request"}),b.html5Mode(!0)}]),app.controller("confirmationController",["responseService","createRequestService",function(a,b){this.data=a.data,this.addMessage=a.addMessage,this.editRequest=b.editRequest,this.confirmRequest=a.confirmRequest,this.deleteRequest=a.deleteRequest,this.confirmDelete=a.confirmDelete,this.confirmCheck=a.confirmCheck,this.updateConfirmation=b.updateConfirmation,a.loadRequest()}]),app.controller("dashboardController",["loginService","eventsService","createRequestService","responseService","$location",function(a,b,c,d,e){this.user=a.user,this.data=b.data,this.requestsObj=c.data,this.requestFalseUpdate=c.requestFalseUpdate,this.requestDetails=function(a){d.loadRequest(a),c.data.holdId=a,e.path("/admin/confirm")},b.getEvents(),c.loadRequests()}]),app.controller("indexController",["$scope","loginService","$location",function(a,b,c){a.userLoggedIn=b.userLoggedIn,a.user=b.currentUser,a.logout=b.logout,a.logoClick=function(){a.user.admin===!0&&c.path("/admin/dashboard")}}]),app.controller("loginController",["loginService","createRequestService",function(a,b,c){this.user=a.user,this.login=a.login}]),app.controller("newRequestController",["createRequestService","eventsService","saladService",function(a,b,c){this.data=a.data,this.eventsData=b.data,this.saladsData=c.data,this.newEvent=a.newEvent,this.oldData=a.oldData,this.cancelEvent=a.cancelEvent,this.addSalad=a.addSalad,this.recipients=a.getRecipients,this.saveRequest=a.saveRequest,this.sendRequest=a.sendRequest,this.newEditRequest=a.newEditRequest,this.editValue=a.editValue,this.addEvent=function(){a.addEvent(),c.getSalads(),this.saladsData=c.data,console.log("function hit",this.saladsData)},b.getEvents(),c.getSalads(),a.getRecipients()}]),app.controller("reportsController",["createRequestService","eventsService","saladService","loginService",function(a,b,c,d){var e=0;this.user=d.user,this.requests=a.data.requests,this.recipients=a.data,a.getRecipients(),this.grabUserReport=function(){e++,1>=e?(f(),this.allReports=gardenConfirmationDisplay.gardens):this.allReports=gardenConfirmationDisplay.gardens},gardenConfirmationDisplay={gardens:[]};var f=function(){var b=0,c="",d="",e="",f="",g="",h={name:"",vegetables:[]},i=0,j=0;this.requests=a.data.requests;for(var k=0;k<this.requests.length;k++)for(var l=0;l<this.requests[k].recipients.length;l++){j=0===gardenConfirmationDisplay.gardens.length?1:gardenConfirmationDisplay.gardens.length;for(var m=0;j>m;m++)if(0===gardenConfirmationDisplay.gardens.length)c=!0;else if(this.requests[k].recipients[l].orgName!=gardenConfirmationDisplay.gardens[m].name)c=!0;else{c=!1;for(var n in this.requests[k].recipients[l].confirmations){i=0===gardenConfirmationDisplay.gardens[m].vegetables.length?1:gardenConfirmationDisplay.gardens[m].vegetables.length;for(var o=0;i>o;o++)if(0===gardenConfirmationDisplay.gardens[m].vegetables.length)d=!0;else if(n!=gardenConfirmationDisplay.gardens[m].vegetables[o].name)d=!0;else{for(d=!1,s=0;s<this.requests[k].summary.length;s++)n==this.requests[k].summary[s].ingredient_name?gardenConfirmationDisplay.gardens[m].vegetables[o].unit!=this.requests[k].summary[s].unit?"lbs."==gardenConfirmationDisplay.gardens[m].vegetables[o].unit&&"oz."==this.requests[k].summary[s].unit?(b=this.requests[k].recipients[l].confirmations[n].quantity/16,s=this.requests[k].summary.length,f=!0):"oz."==gardenConfirmationDisplay.gardens[m].vegetables[o].unit&&"lbs."==this.requests[k].summary[s].unit&&(b=16*this.requests[k].recipients[l].confirmations[n].quantity,s=this.requests[k].summary.length,f=!0):(gardenConfirmationDisplay.gardens[m].vegetables[o].quantity+=this.requests[k].recipients[l].confirmations[n].quantity,f=!1,s=this.requests[k].summary.length):f=!1,f===!0&&(gardenConfirmationDisplay.gardens[m].vegetables[o].quantity+=b);o=i}if(d===!0){for(s=0;s<this.requests[k].summary.length;s++)n!=this.requests[k].summary[s].ingredient_name?e=!1:(e=!0,g=s,s=this.requests[k].summary.length);e===!0&&(currentVeg={name:n,quantity:this.requests[k].recipients[l].confirmations[n].quantity,unit:this.requests[k].summary[g].unit},gardenConfirmationDisplay.gardens[m].vegetables.push(currentVeg))}}m=j}h={},c===!0&&(h.name=this.requests[k].recipients[l].orgName,h.vegetables=[],gardenConfirmationDisplay.gardens.push(h),l--,m--)}this.allReports=gardenConfirmationDisplay.gardens}}]),app.controller("responseController",["loginService","responseService",function(a,b){this.user=a.user,this.data=b.data,this.userLoggedIn=a.userLoggedIn;var c=a.userLoggedIn.respondId;b.loadRequest(c),this.test=function(){},this.sendResponse=b.sendResponse,this.validateResponse=b.validateResponse}]),app.controller("saladController",["loginService","saladService","$scope","$http",function(a,b,c,d){this.user=a.user,c.listNewIngredients=[];var e={};c.showSalads=function(){b.getSalads(),c.salads=b,c.ingredientsDatabase=b},c.cancelCreation=function(){c.newSalad={},c.newIngredient={},c.createNewIngredient={},c.listNewIngredients=[]},c.editSalad=function(){d.post("/salad/editSalad",editData).then(function(a){})},c.createNewSalad=function(a){if("undefined"==typeof a||""===a)return c.addSaladError=!0,void(c.addSaladErrorMessage="Please add a salad name");if(c.listNewIngredients.length<1)return c.addSaladError=!0,void(c.addSaladErrorMessage="Please add ingredients to the salad");var b={saladName:a,ingredientArray:c.listNewIngredients};d.post("/salad/createSalad",b).then(function(a){c.newSalad={},c.listNewIngredients=[],c.saladCreator=!1,c.showSalads()})},c.removeSaladError=function(){c.addSaladError=!1,c.addSaladErrorMessage=""},c.createIngredient=function(a){d.post("/salad/createIngredient",a).then(function(a){c.createNewIngredient={},c.showSalads()})},c.confirmDelete=function(a){c.showDeleteModal=!0,c.confirmIcon=!1,c.deleteMessage="Are you sure?",e=a},c.removeDeleteModal=function(){c.showDeleteModal=!1,c.confirmIcon=!1,c.deleteMessage="Are you sure?"},c.deleteSalad=function(){c.confirmIcon=!0,d.post("/salad/deleteSalad",e).then(function(a){c.showDeleteModal=!1,c.deleteMessage="",c.confirmIcon=!1,c.showSalads()})},c.pushIngredient=function(a){return"undefined"==typeof a?(c.addIngredientError=!0,void(c.addIngredientErrorMessage="Please select an ingredient")):a.name?a.quantity?a.unit?(c.listNewIngredients.push(a),void(c.newIngredient={})):(c.addIngredientError=!0,void(c.addIngredientErrorMessage="Please select a unit")):(c.addIngredientError=!0,void(c.addIngredientErrorMessage="Please select a quantity")):(c.addIngredientError=!0,void(c.addIngredientErrorMessage="Please select an ingredient"))},c.removeIngredientError=function(){c.addIngredientError=!1,c.addIngredientErrorMessage=""},c.showSalads()}]),app.factory("createRequestService",["$http","$location",function(a,b){var c="",d={editPage:"",requestButtons:"",word:"","if":!1},e={event:[],recipients:[],summary:[]},f={events:[],salads:[],requests:[],saladCounterArray:[{id:0}],confirmRequest:!1},g={salads:[]},h=0,i=0,j={},k=function(){if(!g.event||g.event.length<1)return console.log("event error folks"),f.eventError=!0,void(f.eventErrorMessage="Please select an event date from the dropdown.");if(!g.event||g.salads.length<1)return console.log("salad error folks"),f.eventError=!0,void(f.eventErrorMessage="Please select a salad from the dropdown.");for(var a=0;a<g.salads.length;a++)g.salads[a].quantity||(g.salads[a].quantity=g.salads[a].salad.totalSalads);f.summary=vCalc(g.salads),f.events.push({event:g.event,date:g.event.date,salads:g.salads.splice(0),id:h}),h++},l=function(){i++,f.saladCounterArray.push({id:i})},m=function(){a.get("/requestRecipients/recipients").then(function(a){f.recipients=a.data})},n=function(){f.confirmMessage="Are you sure? ",f.dataValidated=!0,f.events&&0!==f.events.length||(f.confirmMessage+="You didn't add any events.",f.dataValidated=!1);for(var a=!1,b=0;b<f.recipients.length;b++)f.recipients[b].checked===!0&&(a=!0);a||(console.log("no recipients"),f.confirmMessage+="You didn't add any recipients.",f.dataValidated=!1),f.confirmRequest=!0},o=function(){f.confirmMessage="",f.confirmIcon=!0,j={recipients:f.recipients,events:f.events,message:f.message,summary:f.summary},a.post("/createRequest",j).then(function(a){f.confirmIcon=!1,f.confirmRequest=!1,f.events=[],j={},f.summary=[],summary=[],f.message="",i=1,p()})},p=function(){a.get("/createRequest/getRequests").then(function(a){f.requests=a.data,b.path("admin/dashboard")})},q=function(a){},r=function(){u(),d.editPage=!1,d.requestButtons=!0,d.word="Edit New",c=f.holdId,d["if"]=!0},s=function(){d.editPage=!1,d.requestButtons=!1,d.word="New",d["if"]=!1},t=function(){j={recipients:f.recipients,events:f.events,message:f.message,summary:f.summary,idHolder:f.holdId},a.post("/createRequest/editRequest",j).then(function(a){f.events=[],j={},f.summary=[],f.message="",b.path("/admin/dashboard")})},u=function(){var b={idHolder:f.holdId};a.post("/createRequest/findOldRequest",b).then(function(a){e.event=a.data.event,e.recipients=a.data.recipients,e.summary=a.data.summary})},v=function(){f.events=[],j={},f.summary=[],f.message="",summary=[]},w=function(c){a.post("/createRequest/updateConfirmation",c).then(function(a){b.path("admin/dashboard")})};return{addEvent:k,updateConfirmation:w,addSalad:l,getRecipients:m,saveRequest:o,sendRequest:n,loadRequests:p,newEvent:g,oldData:e,editRequest:r,newEditRequest:t,requestFalseUpdate:s,requestDetails:q,showPreviousRequest:u,editValue:d,cancelEvent:v,data:f}}]),app.factory("eventsService",["$http","$filter",function(a,b){var c={},d=[],e={},f=function(){d=[],a.get("/events").then(function(a){c.events=a.data;for(var f=0;f<c.events.length;f++){e.location=c.events[f].venueName;for(var g=0;g<c.events[f].events.length;g++)e.date=c.events[f].events[g].eventDate,e.displayDate=b("date")(e.date,"MMM d, yyyy"),e.host=c.events[f].events[g].orgName,d.push(e),e={},e.location=c.events[f].venueName}c.events=d})};return{getEvents:f,data:c}}]),app.factory("loginService",["$http","$location","createRequestService",function(a,b,c){var d={},e={loggedIn:!1,respondId:""},f={data:"",admin:!1},g=function(){a.post("/authenticate/login",this.user).then(function(a){d=a.data.user,a.data.id&&(e.respondId=a.data.id),a.data===!1?(b.path("/"),console.log("false"),alert("Login failed. Please try again.")):d.isAdmin===!0?(e.loggedIn=!0,f.admin=a.data.user.isAdmin,f.data=a.data.user.firstName,console.log("admin"),b.path("/admin/dashboard")):d.isAdmin===!1?(e.loggedIn=!0,f.admin=a.data.user.isAdmin,f.data=a.data.user.firstName,b.path("/farm/response"),console.log("user")):(b.path("/"),alert("Login failed. Please try again."))})},h=function(){a.get("/authenticate/logout").then(function(a){b.path("/")})};return{login:g,logout:h,userLoggedIn:e,currentUser:f,user:d}}]),app.factory("responseService",["$http","$location","loginService",function(a,b,c){var d={exitConfirm:!1,confirmRequest:!1,confirmIcon:!1,deleteError:!1,deleteIcon:!1,confirmError:!1};d.fromAdminMessages=[];var e=function(){d.deleteError=!0,d.deleteMessage="Are you sure?"},f=function(b){a.get("/createRequest/getRequests/"+b).then(function(a){d.request=a.data,d.eventsInfo=[],d.fromAdminMessages=[];for(var b=a.data.event,c=a.data.recipients,e=0;e<b.length;e++)d.eventsInfo.push(b[e].event);for(var e=0;e<c.length;e++)void 0!==c[e].toAdminMessage&&(d.toAdminMessage=c[e].toAdminMessage);for(var e=0;e<c.length;e++)if(void 0!==c[e].fromAdminMessage){var f={name:c[e].name,message:c[e].fromAdminMessage};d.fromAdminMessages.push(f)}})},g=function(){d.confirmRequest=!0,d.confirmMessage="Are you sure? ",recipients=d.request.recipients;for(var a=0;a<recipients.length;a++)if(recipients[a].email===c.user.username&&("undefined"==typeof recipients[a].commitments||null===recipients[a].commitments))return void(d.confirmMessage+="No vegetables added. ");("undefined"==typeof d.toAdminMessage||null===d.toAdminMessage||""===d.toAdminMessage)&&(d.confirmMessage+="No message added.")},h=function(b){for(var e=0;e<d.request.recipients.length;e++)d.request.recipients[e].email===c.user.username&&(d.request.recipients[e].toAdminMessage=d.toAdminMessage);var f={dataRequest:d.request,user:b},g=d.request._id;a.put("/createRequest/updateRequest/"+g,f).then(function(a){console.log(a)}),d.exitConfirm=!0},i=function(){d.confirmError=!0,d.confirmErrorMessage="Are you sure?"},j=function(){d.confirmIcon=!0;var c=d.request._id;a.put("/createRequest/confirmRequest/"+c,d.request).then(function(a){d.confirmError=!1,d.confirmErrorMessage="",b.path("/admin/dashboard")})},k=function(){if("undefined"==typeof this.messageRecipient||null===this.messageRecipient)return d.addMessageError=!0,void(d.addMessageErrorMessage="Please choose a recipient");if("undefined"==typeof this.message||null===this.message||this.message.length<1)return d.addMessageError=!0,void(d.addMessageErrorMessage="Please add a message for "+this.messageRecipient.name);var a=this.messageRecipient.name,b=this.message,c=d.request.recipients,e={name:a,message:b};d.fromAdminMessages.push(e);for(var f=0;f<c.length;f++)c[f].name==a&&(c[f].fromAdminMessage=b)},l=function(c){d.deleteIcon=!0;var e={id:c};a.post("/createRequest/deleteRequest",e).then(function(a){d.deleteIcon=!1,d.deleteError=!1,b.path("/admin/dashboard")})};return{loadRequest:f,deleteRequest:l,sendResponse:h,confirmRequest:j,confirmDelete:e,confirmCheck:i,addMessage:k,validateResponse:g,data:d}}]),app.factory("saladService",["$http",function(a){var b={},c=function(){},d=function(){a.post("/salad/fillSalad").then(function(a){b.salads=a.data.salads,console.log("service hit",b.salads),0!==a.data.ingredient.length?b.ingredientsDatabase=a.data.ingredient[0].ingredients:console.log("no ingredients")})};return{addSalad:c,getSalads:d,data:b}}]);var summary=[];vCalc=function(a){function b(a){if(summary.length>1){for(var b=0;b<summary.length;b++)if(summary[b].ingredient_name==a.ingredient_name)return void(summary[b].unit==a.unit?summary[b].amount+=a.amount:"oz."==summary[b].unit&&"lbs."==a.unit?summary[b].amount+=a.amount/16:"lbs."==summary[b].unit&&"oz."==a.unit&&(summary[b].amount+=16*a.amount));summary.push(a)}else summary.push(a)}for(var c=0;c<a.length;c++)for(var d=a[c].quantity,e=a[c].salad,f=0;f<e.ingredients.length;f++)ingredient=e.ingredients[f],ingredient.amount=ingredient.amount*d/e.totalSalads,"oz."==ingredient.unit&&ingredient.amount>100&&(ingredient.amount/=16,ingredient.unit="lbs."),b(ingredient);return summary};